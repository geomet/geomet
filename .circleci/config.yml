version: 2.1

# Common definition of the build container.
# Helps keep job configs (below) a bit more concise.
build_container: &build_container
    docker:
        # This image is Debian-based.
        - image: circleci/python:3.8

filter_build_test_package: &filter_build_test_package
    filters:
        tags: 
            ignore: release-*
        branches:
            ignore: release-*

# Use this ONLY for release builds.
filter_release: &filter_release
    filters:
        tags:
            ignore: /.*/
        branches:
            only: release-*

jobs:
    install_dependencies:
        <<: *build_container

        steps:
            - checkout
            - run:
                name: Install build/test dependencies
                command: |                
                    python -m venv geomet_build_deps
                    . geomet_build_deps/bin/activate
                    ./build-scripts/00-install-dependencies.sh
            - persist_to_workspace:
                root: .
                paths:
                    # Persist the entire workspace, including the
                    # checked-out repo and the venv we just created.
                    - "."

    build:
        <<: *build_container
        steps:
            - attach_workspace:
                at: ~/project
            - run:
                name: Build and install geomet
                command: |
                    . geomet_build_deps/bin/activate
                    pwd
                    ls -la
                    ./build-scripts/01-build.sh
            - persist_to_workspace:
                root: .
                paths:
                    # Persist the entire workspace, including the
                    # checked-out repo and the venv we just created.
                    - "."
    test:
        <<: *build_container
        steps:
            - attach_workspace:
                at: ~/project
            - run:
                name: Run test suite
                command: |
                    . geomet_build_deps/bin/activate
                    ./build-scripts/02-test.sh
    package:
        <<: *build_container
        steps:
            - attach_workspace:
                at: ~/project
            - run:
                name: Create built distribution package
                command: |
                    . geomet_build_deps/bin/activate
                    ./build-scripts/03-package.sh
            - persist_to_workspace:
                root: .
                paths:
                    # Persist the entire workspace, including the
                    # checked-out repo and the venv we just created.
                    - "."
    publish_dryrun:
        <<: *build_container
        steps:
            - attach_workspace:
                at: ~/project
            - run:
                name: Perform PyPI publishing dry-run
                command: |
                    . geomet_build_deps/bin/activate
                    ./build-scripts/04-push-dryrun.sh
    publish:
        <<: *build_container
        steps:
            - attach_workspace:
                at: ~/project
            - run:
                name: Publish distribution package to PyPI
                command: |
                    . geomet_build_deps/bin/activate
                    ./build-scripts/05-push.sh


workflows:
    version: 2.1
    build_and_test:
        jobs:
            - install_dependencies
            - build:
                requires: [install_dependencies]
                <<: *filter_build_test_package
            - test:
                requires: [build]
                <<: *filter_build_test_package
            - package:
                requires: [build]
                <<: *filter_build_test_package
            # - push_dryrun:
            #     requires: [package]
    release:
        jobs:
            - install_dependencies
            - build:
                requires: [install_dependencies]
                <<: *filter_release
            - test:
                requires: [build]
                <<: *filter_release
            - package:
                requires: [build]
                <<: *filter_release
            - publish_dryrun:
                requires: [package, test]
                <<: *filter_release
            - publish:
                requires: [publish_dryrun]
                <<: *filter_release

